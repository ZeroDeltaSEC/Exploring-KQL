Ah, Ã®nÈ›eleg! Vrei sÄƒ generezi un text formatat gata pentru copy-paste care sÄƒ arate exact ca Ã®n poza. ÃÈ›i voi arÄƒta cum sÄƒ creezi un query KQL care sÄƒ producÄƒ textul formatat.
Query pentru generarea textului formatat
kqllet MessageID = "1234xyz";
EmailEvents
| where NetworkMessageId == MessageID
| join kind=leftouter (
    EmailAttachmentInfo
    | where NetworkMessageId == MessageID
    | summarize AttachmentCount = count()
) on NetworkMessageId
| join kind=leftouter (
    EmailUrlInfo
    | where NetworkMessageId == MessageID  
    | summarize URLCount = count()
) on NetworkMessageId
| extend 
    AuthDetails = parse_json(AuthenticationDetails),
    SPF_Result = iif(isempty(tostring(parse_json(AuthenticationDetails).SPF)), "unset", tostring(parse_json(AuthenticationDetails).SPF)),
    DKIM_Result = iif(isempty(tostring(parse_json(AuthenticationDetails).DKIM)), "unset", tostring(parse_json(AuthenticationDetails).DKIM)),
    DMARC_Result = iif(isempty(tostring(parse_json(AuthenticationDetails).DMARC)), "unset", tostring(parse_json(AuthenticationDetails).DMARC)),
    CompAuth_Result = iif(isempty(tostring(parse_json(AuthenticationDetails).CompAuth)), "unset", tostring(parse_json(AuthenticationDetails).CompAuth)),
    AttCount = iif(isempty(AttachmentCount), 0, AttachmentCount),
    UrlCount = iif(isempty(URLCount), 0, URLCount)
| project FormattedReport = strcat(
    "Email Analysis Report\n\n",
    "ğŸ• Time: ", format_datetime(TimeGenerated, "yyyy-MM-dd HH:mm:ss"), "\n",
    "ğŸ‘¤ Sender: ", SenderFromAddress, " (", SenderFromAddress, ")\n", 
    "ğŸ“§ Recipient: ", RecipientEmailAddress, "\n",
    "ğŸŒ Sender IP: ", SenderIPv4, "\n\n",
    "ğŸ” Authentication:\n",
    "â€¢ SPF: ", SPF_Result, "\n",
    "â€¢ DKIM: ", DKIM_Result, "\n", 
    "â€¢ DMARC: ", DMARC_Result, "\n",
    "â€¢ CompAuth: ", CompAuth_Result, "\n\n",
    "ğŸ“ Attachments: ", AttCount, "\n",
    "ğŸ”— URL Count: ", UrlCount, "\n\n",
    "ğŸ“¦ Delivery: ", DeliveryAction, "\n",
    "ğŸ“‹ Subject: ", Subject, "\n"
)
| project-away NetworkMessageId1, URLCount, AttachmentCount
AlternativÄƒ cu format exact ca Ã®n pozÄƒ
kqllet MessageID = "1234xyz";
EmailEvents
| where NetworkMessageId == MessageID
| join kind=leftouter (
    EmailAttachmentInfo
    | where NetworkMessageId == MessageID
    | summarize AttachmentCount = count()
) on NetworkMessageId
| join kind=leftouter (
    EmailUrlInfo
    | where NetworkMessageId == MessageID  
    | summarize URLCount = count()
) on NetworkMessageId
| extend 
    SPF_Status = iif(isempty(tostring(parse_json(AuthenticationDetails).SPF)), "unset", tostring(parse_json(AuthenticationDetails).SPF)),
    DKIM_Status = iif(isempty(tostring(parse_json(AuthenticationDetails).DKIM)), "unset", tostring(parse_json(AuthenticationDetails).DKIM)),
    DMARC_Status = iif(isempty(tostring(parse_json(AuthenticationDetails).DMARC)), "unset", tostring(parse_json(AuthenticationDetails).DMARC)),
    CompAuth_Status = iif(isempty(tostring(parse_json(AuthenticationDetails).CompAuth)), "unset", tostring(parse_json(AuthenticationDetails).CompAuth))
| extend CopyPasteText = strcat(
    "Email Analysis Report\n",
    "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n",
    "ğŸ• Time: ", format_datetime(TimeGenerated, "yyyy-MM-dd HH:mm:ss"), "\n",
    "ğŸ‘¤ Sender: ", SenderFromAddress, " (<", SenderFromAddress, ">)\n",
    "ğŸ“§ Recipient: ", RecipientEmailAddress, "\n", 
    "ğŸŒ Sender IP: ", SenderIPv4, "\n\n",
    "ğŸ” Authentication:\n",
    "   â€¢ SPF: ", SPF_Status, "\n",
    "   â€¢ DKIM: ", DKIM_Status, "\n",
    "   â€¢ DMARC: ", DMARC_Status, "\n", 
    "   â€¢ CompAuth: ", CompAuth_Status, "\n\n",
    "ğŸ“ Attachments: ", iif(isempty(AttachmentCount), "0", tostring(AttachmentCount)), "\n",
    "ğŸ”— URL Count: ", iif(isempty(URLCount), "0", tostring(URLCount)), "\n\n",
    "ğŸ“¦ Delivery: ", DeliveryAction, "\n",
    "ğŸ“‹ Subject: ", Subject, "\n\n",
    "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
)
| project CopyPasteText
Cum sÄƒ foloseÈ™ti Ã®n Workbook

AdaugÄƒ o celulÄƒ Query cu unul din query-urile de mai sus
ÃnlocuieÈ™te "1234xyz" cu parametrul {MessageID}
SeteazÄƒ vizualizarea la "Table"
ConfigureazÄƒ tabla:

Ascunde header-ul
SeteazÄƒ coloana sÄƒ ocupe toatÄƒ lÄƒÈ›imea
ActiveazÄƒ word wrap pentru text lung



Query simplificat pentru test rapid
kqlEmailEvents
| where NetworkMessageId == "1234xyz"
| extend ReportText = strcat(
    "Time: ", TimeGenerated, "\n",
    "Sender: ", SenderFromAddress, "\n",
    "Recipient: ", RecipientEmailAddress, "\n", 
    "Sender IP: ", SenderIPv4, "\n",
    "Subject: ", Subject
)
| project ReportText
Rezultatul va fi un text formatat pe care Ã®l poÈ›i selecta direct din rezultatul query-ului È™i da copy-paste. Textul va arÄƒta exact ca Ã®n raportul din poza ta!
