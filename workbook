
Ah, Ã®nÈ›eleg! Vrei sÄƒ generezi un text formatat gata pentru copy-paste care sÄƒ arate exact ca Ã®n poza. ÃÈ›i voi arÄƒta cum sÄƒ creezi un query KQL care sÄƒ producÄƒ textul formatat.
Query pentru generarea textului formatat
kqllet MessageID = "1234xyz";
EmailEvents
| where NetworkMessageId == MessageID
| join kind=leftouter (
    EmailAttachmentInfo
    | where NetworkMessageId == MessageID
    | summarize AttachmentCount = count()
) on NetworkMessageId
| join kind=leftouter (
    EmailUrlInfo
    | where NetworkMessageId == MessageID  
    | summarize URLCount = count()
) on NetworkMessageId
| extend 
    AuthDetails = parse_json(AuthenticationDetails),
    SPF_Result = iif(isempty(tostring(parse_json(AuthenticationDetails).SPF)), "unset", tostring(parse_json(AuthenticationDetails).SPF)),
    DKIM_Result = iif(isempty(tostring(parse_json(AuthenticationDetails).DKIM)), "unset", tostring(parse_json(AuthenticationDetails).DKIM)),
    DMARC_Result = iif(isempty(tostring(parse_json(AuthenticationDetails).DMARC)), "unset", tostring(parse_json(AuthenticationDetails).DMARC)),
    CompAuth_Result = iif(isempty(tostring(parse_json(AuthenticationDetails).CompAuth)), "unset", tostring(parse_json(AuthenticationDetails).CompAuth)),
    AttCount = iif(isempty(AttachmentCount), 0, AttachmentCount),
    UrlCount = iif(isempty(URLCount), 0, URLCount)
| project FormattedReport = strcat(
    "Email Analysis Report\n\n",
    "ğŸ• Time: ", format_datetime(TimeGenerated, "yyyy-MM-dd HH:mm:ss"), "\n",
    "ğŸ‘¤ Sender: ", SenderFromAddress, " (", SenderFromAddress, ")\n", 
    "ğŸ“§ Recipient: ", RecipientEmailAddress, "\n",
    "ğŸŒ Sender IP: ", SenderIPv4, "\n\n",
    "ğŸ” Authentication:\n",
    "â€¢ SPF: ", SPF_Result, "\n",
    "â€¢ DKIM: ", DKIM_Result, "\n", 
    "â€¢ DMARC: ", DMARC_Result, "\n",
    "â€¢ CompAuth: ", CompAuth_Result, "\n\n",
    "ğŸ“ Attachments: ", AttCount, "\n",
    "ğŸ”— URL Count: ", UrlCount, "\n\n",
    "ğŸ“¦ Delivery: ", DeliveryAction, "\n",
    "ğŸ“‹ Subject: ", Subject, "\n"
)
| project-away NetworkMessageId1, URLCount, AttachmentCount
AlternativÄƒ cu format exact ca Ã®n pozÄƒ
kqllet MessageID = "1234xyz";
EmailEvents
| where NetworkMessageId == MessageID
| join kind=leftouter (
    EmailAttachmentInfo
    | where NetworkMessageId == MessageID
    | summarize AttachmentCount = count()
) on NetworkMessageId
| join kind=leftouter (
    EmailUrlInfo
    | where NetworkMessageId == MessageID  
    | summarize URLCount = count()
) on NetworkMessageId
| extend 
    SPF_Status = iif(isempty(tostring(parse_json(AuthenticationDetails).SPF)), "unset", tostring(parse_json(AuthenticationDetails).SPF)),
    DKIM_Status = iif(isempty(tostring(parse_json(AuthenticationDetails).DKIM)), "unset", tostring(parse_json(AuthenticationDetails).DKIM)),
    DMARC_Status = iif(isempty(tostring(parse_json(AuthenticationDetails).DMARC)), "unset", tostring(parse_json(AuthenticationDetails).DMARC)),
    CompAuth_Status = iif(isempty(tostring(parse_json(AuthenticationDetails).CompAuth)), "unset", tostring(parse_json(AuthenticationDetails).CompAuth))
| extend CopyPasteText = strcat(
    "Email Analysis Report\n",
    "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n",
    "ğŸ• Time: ", format_datetime(TimeGenerated, "yyyy-MM-dd HH:mm:ss"), "\n",
    "ğŸ‘¤ Sender: ", SenderFromAddress, " (<", SenderFromAddress, ">)\n",
    "ğŸ“§ Recipient: ", RecipientEmailAddress, "\n", 
    "ğŸŒ Sender IP: ", SenderIPv4, "\n\n",
    "ğŸ” Authentication:\n",
    "   â€¢ SPF: ", SPF_Status, "\n",
    "   â€¢ DKIM: ", DKIM_Status, "\n",
    "   â€¢ DMARC: ", DMARC_Status, "\n", 
    "   â€¢ CompAuth: ", CompAuth_Status, "\n\n",
    "ğŸ“ Attachments: ", iif(isempty(AttachmentCount), "0", tostring(AttachmentCount)), "\n",
    "ğŸ”— URL Count: ", iif(isempty(URLCount), "0", tostring(URLCount)), "\n\n",
    "ğŸ“¦ Delivery: ", DeliveryAction, "\n",
    "ğŸ“‹ Subject: ", Subject, "\n\n",
    "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
)
| project CopyPasteText
Cum sÄƒ foloseÈ™ti Ã®n Workbook

AdaugÄƒ o celulÄƒ Query cu unul din query-urile de mai sus
ÃnlocuieÈ™te "1234xyz" cu parametrul {MessageID}
SeteazÄƒ vizualizarea la "Table"
ConfigureazÄƒ tabla:

Ascunde header-ul
SeteazÄƒ coloana sÄƒ ocupe toatÄƒ lÄƒÈ›imea
ActiveazÄƒ word wrap pentru text lung



Query simplificat pentru test rapid
kqlEmailEvents
| where NetworkMessageId == "1234xyz"
| extend ReportText = strcat(
    "Time: ", TimeGenerated, "\n",
    "Sender: ", SenderFromAddress, "\n",
    "Recipient: ", RecipientEmailAddress, "\n", 
    "Sender IP: ", SenderIPv4, "\n",
    "Subject: ", Subject
)
| project ReportText
Rezultatul va fi un text formatat pe care Ã®l poÈ›i selecta direct din rezultatul query-ului È™i da copy-paste. Textul va arÄƒta exact ca Ã®n raportul din poza ta!


Pasul 1: CreeazÄƒ un nou Workbook Ã®n Azure Sentinel
NavigheazÄƒ la Azure Sentinel (Microsoft Sentinel).
Ãn meniul din stÃ¢nga, sub Threat management, selecteazÄƒ Workbooks.
Click pe + Add workbook sau alege un È™ablon existent È™i dÄƒ-i Edit. DacÄƒ alegi un È™ablon gol, dÄƒ click pe Add -> Add text.
Click pe Edit (Ã®n dreapta sus) pentru a intra Ã®n modul de editare al Workbook-ului.
Pasul 2: AdaugÄƒ o interogare KQL pentru a extrage datele
Vom adÄƒuga un pas de interogare care sÄƒ preia toate datele necesare.

DacÄƒ eÈ™ti Ã®n modul de editare al Workbook-ului, click pe Add È™i selecteazÄƒ Add query.

Ãn panoul "Log Analytics query", selecteazÄƒ Logs ca Data source.

Alege spaÈ›iul de lucru Log Analytics (Log Analytics workspace).

CopiazÄƒ È™i insereazÄƒ urmÄƒtoarea interogare KQL Ã®n cÃ¢mpul Log Analytics query.
FOARTE IMPORTANT: Va trebui sÄƒ foloseÈ™ti un parametru pentru Message ID.

Code snippet

EmailEvents
| where NetworkMessageId == '{MessageIDParameter}' // <-- Aici vom folosi un parametru
| project TimeGenerated, SenderFromAddress, RecipientEmailAddress, SenderIp,
          AuthenticationDetails.SpfVerdict, AuthenticationDetails.DkimVerdict, AuthenticationDetails.DmarcVerdict,
          CompositeAuthentication.CompAuthVerdict, HasAttachments, UrlCount,
          DeliveryAction, DeliveryLocation, Subject
| limit 1
| extend ReportGeneratedTime = now()
| extend SPF = iff(isnotempty(SpfVerdict), SpfVerdict, "unset")
| extend DKIM = iff(isnotempty(DkimVerdict), DkimVerdict, "unset")
| extend DMARC = iff(isnotempty(DmarcVerdict), DmarcVerdict, "unset")
| extend CompAuth = iff(isnotempty(CompAuthVerdict), CompAuthVerdict, "unset")
| extend AttachmentsStatus = iff(HasAttachments == true, "Yes", "No")
| extend DeliveryStatus = strcat(iff(isnotempty(DeliveryAction), DeliveryAction, "unset"), " to ", iff(isnotempty(DeliveryLocation), DeliveryLocation, "unset"))
| project-rename Sender = SenderFromAddress, Recipient = RecipientEmailAddress,
             Subject = Subject
| project ReportGeneratedTime, TimeGenerated, Sender, Recipient, SenderIp, SPF, DKIM, DMARC, CompAuth, AttachmentsStatus, UrlCount, DeliveryStatus, Subject
SeteazÄƒ Visualization la Grids (sau la Hidden dacÄƒ nu vrei sÄƒ vezi tabelul).

SeteazÄƒ Time range la o perioadÄƒ suficient de largÄƒ pentru a gÄƒsi emailul (ex: Last 90 days).

Nu rula Ã®ncÄƒ interogarea.

Pasul 3: DefineÈ™te un Parametru pentru Message ID
Pentru ca utilizatorul sÄƒ poatÄƒ introduce Message ID-ul, vom crea un parametru.

Ãn modul de editare al Workbook-ului, click pe Add È™i selecteazÄƒ Add parameter.
Ãn panoul "New Parameter":
Parameter name: MessageIDParameter (trebuie sÄƒ se potriveascÄƒ exact cu ce ai folosit Ã®n KQL, adicÄƒ {MessageIDParameter}).
Display name: Message ID
Parameter type: Text
Required: BifeazÄƒ Required.
Value when empty: LasÄƒ gol sau pune un placeholder.
(OpÈ›ional) Add validation: PoÈ›i adÄƒuga o expresie regularÄƒ dacÄƒ vrei sÄƒ validezi formatul.
Click pe Save Ã®n partea de jos a panoului pentru parametru.
Acum ar trebui sÄƒ vezi un cÃ¢mp de intrare "Message ID" Ã®n partea de sus a Workbook-ului.

Pas 4: AdaugÄƒ un bloc de text care va folosi datele interogÄƒrii
Acesta este pasul cheie pentru a compila direct textul. Vom folosi sintaxa specialÄƒ a Workbook-urilor pentru a referi la rezultatele interogÄƒrii.

Click pe Add È™i selecteazÄƒ Add text.

Ãn editorul de text, vei folosi sintaxa specialÄƒ pentru a referi la rezultatele interogÄƒrii. Interogarea ta va returna un singur rÃ¢nd de date. Fiecare cÃ¢mp poate fi referit folosind {QueryName.FieldName}. PresupunÃ¢nd cÄƒ numele pasului de interogare este Query1 (se vede deasupra cÃ¢mpului de interogare Ã®n modul edit, poÈ›i sÄƒ-l redenumeÈ™ti dacÄƒ vrei pentru claritate, ex. EmailDetailsQuery), vei referi la cÃ¢mpuri ca {EmailDetailsQuery.Sender}.

CopiazÄƒ È™i insereazÄƒ urmÄƒtorul text. AsigurÄƒ-te cÄƒ Query1 corespunde numelui pasului tÄƒu de interogare KQL!

Markdown

Email Analysis Report

Time: {Query1.ReportGeneratedTime}
Sender: {Query1.Sender}
Recipient: {Query1.Recipient}
Sender IP: {Query1.SenderIp}

Authentication:
- SPF: {Query1.SPF}
- DKIM: {Query1.DKIM}
- DMARC: {Query1.DMARC}
- CompAuth: {Query1.CompAuth}

Attachments: {Query1.AttachmentsStatus}
URL Count: {Query1.UrlCount}

Delivery: {Query1.DeliveryStatus}
Subject: {Query1.Subject}
Click pe Done Editing Ã®n panoul de text.

Pasul 5: TesteazÄƒ Workbook-ul
Acum, Ã®n partea de sus a Workbook-ului, ar trebui sÄƒ vezi cÃ¢mpul Message ID.
Introdu un Message ID real (ex: 1234xyz, dar cu ID-ul tÄƒu real) Ã®n cÃ¢mpul Message ID.
ApÄƒsÄƒ Enter sau dÄƒ click pe iconiÈ›a de reÃ®mprospÄƒtare de lÃ¢ngÄƒ cÃ¢mpul Message ID.
DacÄƒ totul este configurat corect, blocurile de text se vor popula automat cu datele extrase din interogarea ta KQL!

Avantajele acestei abordÄƒri cu Workbook-uri:
InterfaÈ›Äƒ Utilizator PrietenoasÄƒ: Orice utilizator poate introduce Message ID-ul fÄƒrÄƒ a cunoaÈ™te KQL.
Automatizare: Nu trebuie sÄƒ copiezi manual rezultatele din tabel Ã®n text. Workbook-ul o face pentru tine.
Reutilizabil: PoÈ›i salva acest Workbook È™i oricine cu permisiuni poate sÄƒ-l foloseascÄƒ.
Vizualizare: PoÈ›i adÄƒuga È™i alte vizualizÄƒri (grafice, tabele) Ã®n acelaÈ™i Workbook dacÄƒ ai nevoie de mai multe detalii.
Copy-Paste Simplificat: OdatÄƒ ce textul este generat, Ã®l poÈ›i selecta È™i copia direct.
Aceasta este cea mai eficientÄƒ metodÄƒ pentru a obÈ›ine un raport formatat automat Ã®n Azure Sentinel. Spune-mi dacÄƒ ai Ã®ntrebÄƒri sau dacÄƒ Ã®ntÃ¢mpini probleme cu vreunul dintre paÈ™i!







