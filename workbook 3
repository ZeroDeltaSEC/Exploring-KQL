ðŸ“š Contents
Before You Start: Accounts, Permissions, and Terminology

One-Time Environment Preparation

Your First Workbook: â€œHello Worldâ€ Exercise (5 min)

Building the Advanced User Investigation Workbook
4.1 Create Global Parameters
4.2 Section 1 â€“ User Search & Selection
4.3 Section 2 â€“ User Profile & Overview
4.4 Section 3 â€“ Device & Location Analysis
4.5 Section 4 â€“ Security Alerts & Incidents
4.6 Section 5 â€“ Risk Scoring & Analytics
4.7 Section 6 â€“ Timeline & Behavioural Analysis
4.8 Section 7 â€“ Geo-Location Intelligence
4.9 Section 8 â€“ Executive Summary & Export

Visualisation Tips (Maps, Timelines, Heat-maps)

Publishing, Sharing, and Version Control

Automation & Alerting (Scheduled rules + Logic Apps)

Performance-Tuning & Troubleshooting

Frequently Asked Questions

Further Learning Path

1 Before You Start
What you need	Why you need it
Azure subscription with at least Contributor on the resource group	Creates resources such as Log Analytics workspace
Microsoft Sentinel enabled on the workspace	Adds SIEM/SOAR capabilities
Permissions: Sentinel Reader (view) or Sentinel Responder (edit)	Controls who can build/modify workbooks
Edge/Chrome browser, pop-ups allowed for Azure Portal	Workbook editor opens blades in new panes

Navigation note (2025) â€“ Sentinel now opens either in the classic Azure portal or inside the unified Microsoft Defender portal.
Path in Defender portal: Microsoft Defender portal â–¶ï¸ â˜° Navigation menu â–¶ï¸ Microsoft Sentinel â–¶ï¸ Threat Management â–¶ï¸ Workbooks. 
Microsoft Learn

Key terms
Term	Meaning
Workbook	Interactive dashboard built with KQL results + visuals
Parameter	Re-usable filter (time picker, dropdown, text box)
KQL	Kusto Query Language â€“ SQL-like syntax used across Azure Monitor and Sentinel
Workspace	Log Analytics data store that Sentinel sits on top of
Data connector	Wizard that on-boards logs such as Azure AD Signin, SecurityEvents, Office365

2 One-Time Environment Preparation
Open portal and switch to the Subscription + Resource Group where Sentinel will live.

Create / locate Log Analytics workspace (LA).

In Microsoft Sentinel â–¶ Settings â–¶ Data Connectors, connect at minimum:

Azure AD Signin Logs

Security Events (Windows)

Office 365

Azure Activity

Verify data flow (one-click query):

kql
Copy
Edit
union withsource = TableName *
| where TimeGenerated > ago(1d)
| summarize Events = count() by TableName
| sort by Events desc
You should see non-zero counts for every required table.

3 First Workbook : â€œHello Worldâ€ (5 minutes)
Doing a quick practice workbook ensures the portal, permissions, and KQL engine all work.

Action	Detail
1. In Workbooks, click âž• Add Workbook.	Youâ€™ll land in Edit mode automatically.
2. Click Add â–¶ Text â†’ type Hello World.	This proves you can save markdown.
3. Click Save â†’ name it Hello World â†’ OK.	You just published a workbook!

Delete it afterwards (â€¦ â–¶ Delete) if you like.

4 Building the Advanced User Investigation Workbook
Pro tip â€“ Keep two browser tabs open: one in Edit mode, one in View mode, and refresh the View tab after each big change.

4.1 Create Global Parameters
In the blank workbook choose Edit.

Add â–¶ Add Parameters (top of blade).

Configure three parameters:

Name	Type	Label	Default	Additional settings
UserSearchParameter	Text	ðŸ” Search User	(blank)	Turn on case-insensitive
TimeRangeParameter	Time range	ðŸ“… Time Range	Last 30 days	Enable Fractions of hours
DeviceParameter	Dropdown	ðŸ–¥ï¸ Select Device	(All)	â€œGet data dynamically from queryâ€ (leave blank for now)

Click Apply changes after each parameter.

4.2 Section 1 â€“ User Search & Selection
Add â–¶ Add query.

Paste the User Search KQL from your original guide.

Under Visualization, choose Table.

At the bottom tick Allow column click actions â†’ pick UserPrincipalName â†’ Create new parameter â†’ name it SelectedUserParameter.

Done Editing â†’ now type part of a userâ€™s UPN in the text box â†’ Run; the table appears, rows are clickable.

What just happened?
You created a dynamic drill-through: selecting a row populates SelectedUserParameter, which the rest of the workbook can read.

4.3 Section 2 â€“ User Profile & Overview
Add query below Section 1.

Paste the Detailed user profile KQL.

Choose Tiles (recommended for KPI cards).

In Tile settings:

Field: TotalSignIns â†’ Tile size L â†’ Colour Automatic.

Add more tiles: FailedSignIns, RiskScore, ActiveDays.

Explain every KQL line to yourself:

Line fragment	Meaning
extend GeoInfo = parse_json(LocationDetails)	JSON column split into usable fields
summarize â€¦ by UserPrincipalName	Aggregates one row per user
extend SuccessRate = round((Successful*100.)/Total,2)	maths calc â€“ always cast to float

(Spend time here; understanding this block lets you debug any later errors.)

4.4 Section 3 â€“ Device & Location Analysis
Create a Table visual from the given query.

Click Advanced Settings â†’ Column Formatting:

Status â†’ choose Conditional â†’ Success = green âœ…, Failure = red âŒ.

RiskIcon â€“ keep as text; icons display in the table cell.

4.5 Section 4 â€“ Security Alerts & Incidents
Because alert volumes explode, always filter early:

kql
Copy
Edit
SecurityAlert
| where TimeGenerated between (TimeRange)
| where Entities has SelectedUser
Add the icons (SeverityIcon, StatusIcon) as separate columns for colour-at-a-glance.

4.6 Section 5 â€“ Risk Scoring & Analytics
Tip for beginners: copy the query into Log Analytics first, run it, and confirm results; then paste into workbook. Common pitfalls:

Scalar vs. record â€“ The BaselineData variable returns a record; you must wrap with toscalar() if you intend to use it as a row.

Date maths â€“ datetime_diff('day', â€¦) returns positive when the first argument is later. Swap order if you want elapsed days.

4.7 Section 6 â€“ Timeline & Behavioural Analysis
Choose visual:

Table if you want click-through.

Line chart if you prefer a visual timeline (set Split by ImpossibleTravel).

Enable Drill-down so clicking a day opens the underlying records.

4.8 Section 7 â€“ Geo-Location Intelligence
In Visualization drop-down pick Map.

Latitude field â†’ SampleLatitude; Longitude field â†’ SampleLongitude.

Size â†’ LoginCount; Colour â†’ RiskEvents.

Turn on Legend (bottom) and Full screen toggle.

ðŸ’¡ Got no map tiles? Check browser pop-up blocker and that you allowed the Azure Maps domain.

4.9 Section 8 â€“ Executive Summary & Export
Add a Text part with a short markdown summary and add an Export button:

@export to='CSV' query='Section 1' filename='UserInvestigation.csv'

Now analysts can snapshot evidence.

5 Visualisation Tips
Use-case	Recommended visual	Key portal options
Countries vs. login count	Map	Bubble = LoginCount, Colour = RiskEvents
Hour x Day heat-map	Heatmap	Aggregation = Average RiskScore
Trend lines for RiskScore	Line chart	Split by Country (shows separate lines)

ðŸ†• The workbook editor received a facelift in January 2025: icons moved to the right-hand collapse bar, and the â€œApplyâ€ button was renamed â€œRunâ€. 
Microsoft Learn

6 Publishing, Sharing & Version Control
Click Save â†’ give the workbook a clear name and Category (e.g. User Investigation).

Click Pin to dashboard if you want a tile on your Azure home page.

Export as an ARM template (â€¦ â–¶ Export) and store under source control; GitHub Actions or Azure DevOps can deploy to other tenants.

Use Microsoft Sentinel â–¶ Content hub to package the workbook as part of a Solution. 
Microsoft Learn

7 Automation & Alerting
Analytics â–¶ âž• Create rule â–¶ Scheduled.

Paste the SuspiciousActivity query.

Set frequency to 15 minutes and Lookup period to 60 minutes.

Set Alert severity dynamically: use High when HighRiskLogins > 0, otherwise Medium.

Automated response: attach a Logic App that sends Teams message and (optionally) triggers an Entra ID access review.

8 Performance-Tuning & Troubleshooting
Symptom	Likely cause	Quick fix
Query time-outs	No early where TimeGenerated filter	Add one, then re-run
Blank visuals	Parameter null / wrong data type	Inspect parameter value with print '{SelectedUserParameter}'
Old threat-intel tables missing	You migrated to new ThreatIntelIndicators / ThreatIntelObjects schema	Replace ThreatIntelligenceIndicator everywhere before 31 July 2025 
Microsoft Learn

9 Frequently Asked Questions
Question	Answer
Can I edit a workbook someone else saved?	Yes, if you have Sentinel Responder or higher on the workspace.
Can non-Sentinel users see the workbook?	Grant them Log Analytics Reader at minimum and share the workbook URL.
Why do icons show as squares?	Your browserâ€™s default font lacks emoji. Install Segoe UI Emoji or use PNG icons.

10 Further Learning Path
KQL 101 â†’ 401 â€“ Official KQL interactive lab (aka.ms/kqllab).

Microsoft Sentinel Ninja Training â€“ Free structured course with certificates.

Community GitHub repo â€“ Hundreds of workbook samples to dissect.

Power BI for Sentinel â€“ Export workbook queries into Power BI for executive dashboards. 
Microsoft Learn

ðŸŽ¯ You are now ready!
Build the workbook slowly, test each section, and commit the JSON to version control after every milestone. In a single afternoon youâ€™ll have a production-ready, drill-down investigation surface that cuts investigation time from hours to minutesâ€”while remaining understandable even to colleagues who have never touched KQL before. Have fun and stay secure!
